<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Список игр Roblox</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            background-color: #f5f5f5;
            font-size: 14px;
        }
        .container {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .game-item {
            border: 1px solid #ddd;
            margin: 8px 0;
            padding: 10px;
            border-radius: 3px;
            background-color: #fafafa;
        }
        .game-id {
            font-weight: bold;
            color: #666;
            margin-bottom: 3px;
        }
        .game-title {
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .game-button {
            background-color: #007AFF;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 3px;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 15px;
        }
        .error {
            color: #D70000;
            background-color: #FFEBEE;
            padding: 10px;
            border-radius: 3px;
            border: 1px solid #F44336;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Список игр Roblox</h1>
        <div id="status"></div>
        <div id="games-list">
            <div class="loading">Загрузка данных...</div>
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <button onclick="loadGames()" style="padding: 8px 15px; font-size: 14px;">Обновить список</button>
        </div>
    </div>

    <script>
        // Простая функция для обновления статуса
        function updateStatus(message, isError) {
            var statusDiv = document.getElementById('status');
            if (isError) {
                statusDiv.innerHTML = '<div class="error">' + message + '</div>';
            } else {
                statusDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 10px;">' + message + '</div>';
            }
        }

        // Функция для исправления JSON (совместимая с iOS 8)
        function fixJSON(text) {
            // Простые замены для исправления распространенных ошибок
            var fixed = text
                .replace(/,\s*(\}|\])/g, '$1') // Убираем запятые перед } и ]
                .replace(/'/g, '"'); // Заменяем одинарные кавычки на двойные
            
            return fixed;
        }

        // Основная функция загрузки игр
        function loadGames() {
            var gamesList = document.getElementById('games-list');
            gamesList.innerHTML = '<div class="loading">Загрузка данных...</div>';
            updateStatus('Подключаемся к серверу...', false);
            
            // Используем XMLHttpRequest вместо fetch для совместимости
            var xhr = new XMLHttpRequest();
            var url = 'https://api.allorigins.win/raw?url=' + 
                     encodeURIComponent('https://games.synt2x.xyz/v1/games/');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) { // Запрос завершен
                    if (xhr.status === 200) {
                        // Успешный запрос
                        processGamesData(xhr.responseText, gamesList);
                    } else {
                        // Ошибка запроса
                        updateStatus('Ошибка загрузки: ' + xhr.status, true);
                        gamesList.innerHTML = '<div class="error">Не удалось загрузить данные</div>';
                    }
                }
            };
            
            xhr.onerror = function() {
                updateStatus('Ошибка сети', true);
                gamesList.innerHTML = '<div class="error">Проблемы с подключением к интернету</div>';
            };
            
            xhr.open('GET', url, true);
            xhr.send();
        }

        // Функция обработки данных
        function processGamesData(text, gamesList) {
            try {
                var games = [];
                var data;
                
                // Пытаемся распарсить JSON
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    // Если не получается, пытаемся исправить JSON
                    try {
                        var fixedText = fixJSON(text);
                        data = JSON.parse(fixedText);
                    } catch (e2) {
                        throw new Error('Не удалось обработать данные: ' + e2.message);
                    }
                }
                
                // Извлекаем игры из данных
                if (Array.isArray(data)) {
                    games = data;
                } else if (data && typeof data === 'object') {
                    // Пробуем разные структуры данных
                    if (data.games && Array.isArray(data.games)) {
                        games = data.games;
                    } else if (data.data && Array.isArray(data.data)) {
                        games = data.data;
                    } else {
                        // Если это объект, преобразуем в массив
                        games = [];
                        for (var key in data) {
                            if (data.hasOwnProperty(key) && data[key] && data[key].id) {
                                games.push(data[key]);
                            }
                        }
                    }
                }
                
                if (games.length === 0) {
                    throw new Error('Не найдено игр в данных');
                }
                
                // Отображаем игры
                displayGames(games, gamesList);
                updateStatus('Загружено игр: ' + games.length, false);
                
            } catch (error) {
                updateStatus('Ошибка: ' + error.message, true);
                gamesList.innerHTML = '<div class="error">' + error.message + '</div>';
            }
        }

        // Функция отображения игр
        function displayGames(games, gamesList) {
            gamesList.innerHTML = '';
            
            // Сортируем игры по ID
            games.sort(function(a, b) {
                return (a.id || 0) - (b.id || 0);
            });
            
            // Создаем элементы для каждой игры
            for (var i = 0; i < games.length; i++) {
                var game = games[i];
                
                var gameElement = document.createElement('div');
                gameElement.className = 'game-item';
                
                var robloxUrl = 'robloxmobile://Game/PlaceLauncher.ashx?request=RequestGame&placeId=' + (game.placeId || game.id);
                
                gameElement.innerHTML = 
                    '<div class="game-id">ID: ' + (game.id || 'N/A') + '</div>' +
                    '<div class="game-title">Название: ' + (game.title || 'Не указано') + '</div>' +
                    (game.description ? '<div style="color: #666; font-size: 12px; margin: 5px 0;">' + game.description + '</div>' : '') +
                    '<div style="text-align: center; margin-top: 8px;">' +
                    '<a href="' + robloxUrl + '" class="game-button" onclick="handleGameLaunch(event, ' + (game.placeId || game.id) + ')">Запустить игру</a>' +
                    '</div>';
                
                gamesList.appendChild(gameElement);
            }
        }

        // Функция обработки запуска игры
        function handleGameLaunch(event, gameId) {
            if (event) {
                event.preventDefault();
            }
            
            var robloxUrl = 'robloxmobile://Game/PlaceLauncher.ashx?request=RequestGame&placeId=' + gameId;
            
            // Пытаемся открыть в приложении
            window.location.href = robloxUrl;
            
            // Fallback на браузер через 2 секунды
            setTimeout(function() {
                var webUrl = 'https://www.roblox.com/games/' + gameId + '/';
                if (confirm('Не удалось открыть приложение. Открыть в браузере?')) {
                    window.open(webUrl, '_blank');
                }
            }, 2000);
        }

        // Загружаем игры при загрузке страницы
        window.onload = function() {
            loadGames();
        };
    </script>
</body>
</html>
